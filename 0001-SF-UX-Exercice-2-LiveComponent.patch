From 3c4497d68415ae6d8e26a2c65e6ae87b3110bea4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?J=C3=A9r=C3=A9my=20Jarri=C3=A9?=
 <jeremy.jarrie@protonmail.com>
Date: Wed, 13 Aug 2025 15:31:38 +0200
Subject: [PATCH] [SF UX] Exercice 2 - LiveComponent

---
 src/Entity/Conference.php                     |   6 +-
 src/Form/ConferenceType.php                   |   2 +-
 src/Form/ConferencesFilterType.php            |  28 +++++
 .../Conference/AddConferenceForm.php          |  44 ++++++++
 .../Components/Conference/ConferenceList.php  |  36 ++++++
 .../Components/Conference/ListFilterForm.php  |  54 +++++++++
 .../Conference/AddConferenceForm.html.twig    |  11 ++
 .../Conference/ConferenceList.html.twig       |   7 ++
 .../Conference/ListFilterForm.html.twig       |  19 ++++
 templates/conference/new.html.twig            |   2 +-
 19 files changed, 351 insertions(+), 47 deletions(-)
 create mode 100644 src/Form/ConferencesFilterType.php
 create mode 100644 src/Twig/Components/Conference/AddConferenceForm.php
 create mode 100644 src/Twig/Components/Conference/ConferenceList.php
 create mode 100644 src/Twig/Components/Conference/ListFilterForm.php
 create mode 100644 templates/components/Conference/AddConferenceForm.html.twig
 create mode 100644 templates/components/Conference/ConferenceList.html.twig
 create mode 100644 templates/components/Conference/ListFilterForm.html.twig

diff --git a/src/Entity/Conference.php b/src/Entity/Conference.php
index 82b73e3..bd5fd74 100644
--- a/src/Entity/Conference.php
+++ b/src/Entity/Conference.php
@@ -29,7 +29,7 @@ class Conference

     #[Assert\NotNull()]
     #[ORM\Column]
-    private ?bool $accessible = null;
+    private bool $accessible = false;

     #[Assert\Length(min: 20)]
     #[ORM\Column(type: Types::TEXT, nullable: true)]
@@ -123,7 +123,7 @@ class Conference
         return $this->startAt;
     }

-    public function setStartAt(\DateTimeImmutable $startAt): static
+    public function setStartAt(?\DateTimeImmutable $startAt = null): static
     {
         $this->startAt = $startAt;

@@ -135,7 +135,7 @@ class Conference
         return $this->endAt;
     }

-    public function setEndAt(\DateTimeImmutable $endAt): static
+    public function setEndAt(?\DateTimeImmutable $endAt = null): static
     {
         $this->endAt = $endAt;

diff --git a/src/Form/ConferenceType.php b/src/Form/ConferenceType.php
index 2d428c8..420855e 100644
--- a/src/Form/ConferenceType.php
+++ b/src/Form/ConferenceType.php
@@ -20,7 +20,7 @@ class ConferenceType extends AbstractType
         $builder
             ->add('name', TextType::class)
             ->add('description', TextareaType::class)
-            ->add('accessible', CheckboxType::class)
+            ->add('accessible', CheckboxType::class, ['required' => false])
             ->add('prerequisites', TextareaType::class, ['required' => false])
             ->add('startAt', DateType::class, [
                 'widget' => 'single_text',
diff --git a/src/Form/ConferencesFilterType.php b/src/Form/ConferencesFilterType.php
new file mode 100644
index 0000000..3477383
--- /dev/null
+++ b/src/Form/ConferencesFilterType.php
@@ -0,0 +1,28 @@
+<?php
+
+namespace App\Form;
+
+use Symfony\Component\Form\AbstractType;
+use Symfony\Component\Form\Extension\Core\Type\DateType;
+use Symfony\Component\Form\FormBuilderInterface;
+use Symfony\Component\OptionsResolver\OptionsResolver;
+
+class ConferencesFilterType extends AbstractType
+{
+    public function buildForm(FormBuilderInterface $builder, array $options)
+    {
+        $builder->add('fromDate', DateType::class, [
+            'input' => 'datetime_immutable',
+        ])
+            ->add('toDate', DateType::class, [
+                'input' => 'datetime_immutable',
+            ]);
+    }
+
+    public function configureOptions(OptionsResolver $resolver)
+    {
+        $resolver->setDefaults([
+            'csrf_protection' => true,
+        ]);
+    }
+}
diff --git a/src/Twig/Components/Conference/AddConferenceForm.php b/src/Twig/Components/Conference/AddConferenceForm.php
new file mode 100644
index 0000000..a60529c
--- /dev/null
+++ b/src/Twig/Components/Conference/AddConferenceForm.php
@@ -0,0 +1,44 @@
+<?php
+
+namespace App\Twig\Components\Conference;
+
+use App\Entity\Conference;
+use App\Form\ConferenceType;
+use Doctrine\ORM\EntityManagerInterface;
+use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
+use Symfony\Component\Form\FormInterface;
+use Symfony\Component\HttpFoundation\Response;
+use Symfony\UX\LiveComponent\Attribute\AsLiveComponent;
+use Symfony\UX\LiveComponent\Attribute\LiveAction;
+use Symfony\UX\LiveComponent\Attribute\LiveProp;
+use Symfony\UX\LiveComponent\ComponentWithFormTrait;
+use Symfony\UX\LiveComponent\DefaultActionTrait;
+
+#[AsLiveComponent]
+class AddConferenceForm extends AbstractController
+{
+    use DefaultActionTrait;
+    use ComponentWithFormTrait;
+
+    #[LiveProp]
+    public ?Conference $initialFormData = null;
+
+    protected function instantiateForm(): FormInterface
+    {
+        return $this->createForm(ConferenceType::class, $this->initialFormData);
+    }
+
+    #[LiveAction]
+    public function save(EntityManagerInterface $entityManager): Response {
+        $this->submitForm();
+
+        /** @var Conference $conference */
+        $conference = $this->getForm()->getData();
+        $entityManager->persist($conference);
+        $entityManager->flush();
+
+        return $this->redirectToRoute('app_conference_show', [
+            'id' => $conference->getId(),
+        ]);
+    }
+}
diff --git a/src/Twig/Components/Conference/ConferenceList.php b/src/Twig/Components/Conference/ConferenceList.php
new file mode 100644
index 0000000..e141104
--- /dev/null
+++ b/src/Twig/Components/Conference/ConferenceList.php
@@ -0,0 +1,36 @@
+<?php
+
+namespace App\Twig\Components\Conference;
+
+use App\Repository\ConferenceRepository;
+use DateTimeImmutable;
+use Symfony\UX\LiveComponent\Attribute\AsLiveComponent;
+use Symfony\UX\LiveComponent\Attribute\LiveProp;
+use Symfony\UX\LiveComponent\ComponentToolsTrait;
+use Symfony\UX\LiveComponent\DefaultActionTrait;
+
+#[AsLiveComponent]
+class ConferenceList
+{
+    use ComponentToolsTrait;
+    use DefaultActionTrait;
+
+    #[LiveProp]
+    public ?DateTimeImmutable $fromDate = null;
+    #[LiveProp]
+    public ?DateTimeImmutable $toDate = null;
+
+    public function __construct(private ConferenceRepository $conferenceRepository)
+    {
+    }
+
+    public function getConferences(): array
+    {
+        if (null === $this->fromDate && null === $this->toDate) {
+            return $this->conferenceRepository->findAll();
+        } else {
+            return $this->conferenceRepository->findConferencesBetweenDates($this->fromDate, $this->toDate);
+        }
+    }
+
+}
diff --git a/src/Twig/Components/Conference/ListFilterForm.php b/src/Twig/Components/Conference/ListFilterForm.php
new file mode 100644
index 0000000..0cb9aeb
--- /dev/null
+++ b/src/Twig/Components/Conference/ListFilterForm.php
@@ -0,0 +1,54 @@
+<?php
+
+namespace App\Twig\Components\Conference;
+
+use App\Form\ConferencesFilterType;
+use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
+use Symfony\Component\Form\FormInterface;
+use Symfony\Component\HttpFoundation\Response;
+use Symfony\UX\LiveComponent\Attribute\AsLiveComponent;
+use Symfony\UX\LiveComponent\Attribute\LiveAction;
+use Symfony\UX\LiveComponent\Attribute\LiveProp;
+use Symfony\UX\LiveComponent\ComponentToolsTrait;
+use Symfony\UX\LiveComponent\ComponentWithFormTrait;
+
+#[AsLiveComponent]
+class ListFilterForm extends AbstractController
+{
+    use ComponentToolsTrait;
+    use ComponentWithFormTrait;
+
+    #[LiveProp(writable: true, url: true)]
+    public ?\DateTimeImmutable $fromDate = null;
+    #[LiveProp(writable: true, url: true)]
+    public ?\DateTimeImmutable $toDate = null;
+
+    protected function instantiateForm(): FormInterface
+    {
+        return $this->createForm(ConferencesFilterType::class, [
+            'fromDate' => $this->fromDate,
+            'toDate' => $this->toDate,
+        ], [
+            'csrf_protection' => false,
+        ]);
+    }
+
+    public function __invoke()
+    {
+    }
+
+    #[LiveAction]
+    public function filter(): Response {
+        $this->submitForm();
+
+        $datas = $this->getForm()->getData();
+
+        $this->fromDate = $datas['fromDate'];
+        $this->toDate = $datas['toDate'];
+
+        return $this->redirectToRoute('app_conference_list', [
+            'fromDate' => $this->fromDate?->format(\DateTimeInterface::ATOM),
+            'toDate' => $this->toDate?->format(\DateTimeInterface::ATOM),
+        ]);
+    }
+}
diff --git a/templates/components/Conference/AddConferenceForm.html.twig b/templates/components/Conference/AddConferenceForm.html.twig
new file mode 100644
index 0000000..aa7e357
--- /dev/null
+++ b/templates/components/Conference/AddConferenceForm.html.twig
@@ -0,0 +1,11 @@
+<div {{ attributes }}>
+    {{ form_start(form, {
+        attr: {
+            'data-action': 'live#action:prevent',
+            'data-live-action-param': 'save'
+        }
+    }) }}
+        {{ form_widget(form) }}
+        <button type="submit" class="btn btn-primary">{{ button_label|default('Send') }}</button>
+    {{ form_end(form) }}
+</div>
diff --git a/templates/components/Conference/ConferenceList.html.twig b/templates/components/Conference/ConferenceList.html.twig
new file mode 100644
index 0000000..a8f0812
--- /dev/null
+++ b/templates/components/Conference/ConferenceList.html.twig
@@ -0,0 +1,7 @@
+<div class="row row-cols-1 row-cols-md-2 g-4 mb-5" {{ attributes }}>
+    {% for conference in this.conferences %}
+        <twig:Conference:Card :conference="conference" />
+    {% else %}
+        <div>There are no conferences yet...</div>
+    {% endfor %}
+</div>
diff --git a/templates/components/Conference/ListFilterForm.html.twig b/templates/components/Conference/ListFilterForm.html.twig
new file mode 100644
index 0000000..d844c3e
--- /dev/null
+++ b/templates/components/Conference/ListFilterForm.html.twig
@@ -0,0 +1,19 @@
+<div {{ attributes }}>
+    {{ form_start(form) }}
+
+            {{ form_row(form.fromDate, {
+                attr: {
+                    'data-action': 'live#action',
+                    'data-live-action-param': 'filter'
+                }
+            }) }}
+
+            {{ form_row(form.toDate, {
+                attr: {
+                    'data-action': 'live#action',
+                    'data-live-action-param': 'filter'
+                }
+            }) }}
+
+    {{ form_end(form) }}
+</div>
diff --git a/templates/conference/new.html.twig b/templates/conference/new.html.twig
index ff20cf1..b904e24 100644
--- a/templates/conference/new.html.twig
+++ b/templates/conference/new.html.twig
@@ -8,6 +8,6 @@
         <h1>New conference</h1>
     </div>

-    {{ include('includes/_form.html.twig', {button_label: 'Save'}) }}
+    {{ component('Conference:AddConferenceForm') }}
 </section>
 {% endblock %}
--
2.43.0

